{% extends "base.html" %}
{% block title %}{{ user.username or user.telegram_id }}{% endblock %}
{% block content %}
<div style="margin-bottom:24px">
<a href="{{ url_for('users_page') }}" style="color:var(--text-muted);font-size:.875rem">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>
<div class="grid-2">
<div>
<div class="card" style="margin-bottom:24px">
<div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
<div class="user-avatar" style="width:64px;height:64px;font-size:1.5rem">{{ user.username[0]|upper if user.username else 'U' }}</div>
<div style="flex:1">
<h2 style="margin:0;font-size:1.25rem">@{{ user.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</h2>
<div style="font-family:monospace;color:var(--text-muted);font-size:.875rem">{{ user.telegram_id }}</div>
</div>
{% if user.is_banned %}
<span class="badge badge-danger" style="font-size:.875rem;padding:8px 16px">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
{% else %}
<span class="badge badge-success" style="font-size:.875rem;padding:8px 16px">–ê–∫—Ç–∏–≤–µ–Ω</span>
{% endif %}
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;padding:16px;background:var(--bg-input);border-radius:8px;margin-bottom:20px">
<div style="text-align:center">
<div style="font-size:1.5rem;font-weight:600">{{ user.user_keys|length }}</div>
<div style="font-size:.75rem;color:var(--text-muted)">–ö–ª—é—á–µ–π</div>
</div>
<div style="text-align:center">
<div style="font-size:1.5rem;font-weight:600">{{ (user.total_spent or 0)|float|round(0)|int }}‚ÇΩ</div>
<div style="font-size:.75rem;color:var(--text-muted)">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
</div>
<div style="text-align:center">
<div style="font-size:1.5rem;font-weight:600">{{ user.total_months or 0 }}</div>
<div style="font-size:.75rem;color:var(--text-muted)">–ú–µ—Å—è—Ü–µ–≤</div>
</div>
</div>
<div style="font-size:.875rem;color:var(--text-muted);margin-bottom:20px">
<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
<span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
<span style="color:var(--text)">{{ user.registration_date[:10] if user.registration_date else '‚Äî' }}</span>
</div>
<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
<span>–¢—Ä–∏–∞–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</span>
<span style="color:var(--text)">{{ '–î–∞' if user.trial_used else '–ù–µ—Ç' }}</span>
</div>
<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
<span>–†–µ—Ñ. –±–∞–ª–∞–Ω—Å</span>
<span style="color:var(--text)">{{ (user.referral_balance or 0)|float|round(2) }} ‚ÇΩ</span>
</div>
{% if user.referred_by %}
<div style="display:flex;justify-content:space-between;padding:8px 0">
<span>–ü—Ä–∏–≥–ª–∞—à—ë–Ω</span>
<span style="color:var(--text)">{{ user.referred_by }}</span>
</div>
{% endif %}
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
{% if user.is_banned %}
<form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post">
<button type="submit" class="btn btn-success btn-sm">‚úì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
</form>
{% else %}
<form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post" data-confirm="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?">
<button type="submit" class="btn btn-warning btn-sm">‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
</form>
{% endif %}
{% if user.user_keys %}
<form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post" data-confirm="–û—Ç–æ–∑–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ API?">
<button type="submit" class="btn btn-danger btn-sm">üóë –û—Ç–æ–∑–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏</button>
</form>
{% endif %}
</div>
</div>
<div class="card" style="margin-bottom:24px">
<div class="card-title">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
<form action="{{ url_for('send_message_to_user', user_id=user.telegram_id) }}" method="post">
<div class="form-group" style="margin-bottom:12px">
<textarea name="message" class="form-input" rows="3" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (HTML)" required></textarea>
</div>
<button type="submit" class="btn btn-primary btn-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>
</div>
{% if api_subscription %}
<div class="card">
<div class="card-title">üåê –î–∞–Ω–Ω—ã–µ MW API</div>
<div style="font-size:.875rem">
<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
<span style="color:var(--text-muted)">UUID</span>
<code style="font-size:.75rem">{{ api_subscription.uuid[:20] }}...</code>
</div>
<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
<span style="color:var(--text-muted)">Email</span>
<span>{{ api_subscription.email or '‚Äî' }}</span>
</div>
<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
<span style="color:var(--text-muted)">–ò—Å—Ç–µ–∫–∞–µ—Ç</span>
<span>{{ api_subscription.expiry_date[:10] if api_subscription.expiry_date else '‚Äî' }}</span>
</div>
<div style="display:flex;justify-content:space-between;padding:8px 0">
<span style="color:var(--text-muted)">–°—Ç–∞—Ç—É—Å</span>
{% if api_subscription.is_active %}<span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
{% else %}<span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>{% endif %}
</div>
</div>
</div>
{% endif %}
</div>
<div>
<div class="card" style="margin-bottom:24px">
<div class="card-title">üéÅ –í—ã–¥–∞—Ç—å –∫–ª—é—á</div>
<form action="{{ url_for('grant_key_route', user_id=user.telegram_id) }}" method="post">
<div class="form-group">
<label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π</label>
<input type="number" name="days" class="form-input" value="30" min="1" max="365" required>
</div>
<button type="submit" class="btn btn-primary">–í—ã–¥–∞—Ç—å –∫–ª—é—á</button>
</form>
</div>
{% if user.user_keys %}
<div class="card" style="margin-bottom:24px">
<div class="card-title">üìÖ –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫</div>
<form action="{{ url_for('modify_user_days_route', user_id=user.telegram_id) }}" method="post">
<input type="hidden" name="key_id" value="{{ user.user_keys[0].key_id }}">
<div class="form-group">
<label class="form-label">–î–Ω–µ–π (+/-)</label>
<input type="number" name="days" class="form-input" placeholder="+30 –∏–ª–∏ -10" required>
</div>
<p style="font-size:.75rem;color:var(--text-muted);margin-bottom:12px">–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ ‚Äî –æ—Ç–æ–∑–≤–∞—Ç—å</p>
<button type="submit" class="btn btn-ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</form>
</div>
{% endif %}
<div class="card">
<div class="card-title">üîë –ö–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
{% if user.user_keys %}
<div style="display:flex;flex-direction:column;gap:12px">
{% for key in user.user_keys %}
{% set is_active = key.expiry_date > now %}
<div class="key-card {% if is_active %}key-active{% else %}key-expired{% endif %}">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-weight:500">–ö–ª—é—á #{{ key.key_id }}</span>
{% if is_active %}<span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
{% else %}<span class="badge badge-danger">–ò—Å—Ç—ë–∫</span>{% endif %}
</div>
<div style="font-size:.8rem;color:var(--text-muted)">
<div>–°–æ–∑–¥–∞–Ω: {{ key.created_date[:10] if key.created_date else '‚Äî' }}</div>
<div>–ò—Å—Ç–µ–∫–∞–µ—Ç: {{ key.expiry_date[:10] if key.expiry_date else '‚Äî' }}</div>
</div>
{% if key.subscription_link %}
<details style="margin-top:8px">
<summary style="cursor:pointer;font-size:.75rem;color:var(--primary)">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É</summary>
<code style="font-size:.7rem;word-break:break-all;display:block;margin-top:8px;padding:8px;background:var(--bg);border-radius:4px">{{ key.subscription_link }}</code>
</details>
{% endif %}
<div style="margin-top:12px;display:flex;gap:8px">
<form action="{{ url_for('revoke_single_key_route', user_id=user.telegram_id, key_id=key.key_id) }}" method="post" data-confirm="–û—Ç–æ–∑–≤–∞—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á?">
<button type="submit" class="btn btn-danger btn-xs">–û—Ç–æ–∑–≤–∞—Ç—å</button>
</form>
</div>
</div>
{% endfor %}
</div>
{% else %}
<p style="color:var(--text-muted);text-align:center;padding:20px">–ù–µ—Ç –∫–ª—é—á–µ–π</p>
{% endif %}
</div>
</div>
</div>
{% endblock %}
