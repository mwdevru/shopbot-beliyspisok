{% extends "base.html" %}
{% block title %}–û–±–Ω–æ–≤–ª–µ–Ω–∏—è{% endblock %}
{% block content %}
<h1 class="page-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</h1>
<div class="grid-2">
<div>
<div class="card" style="margin-bottom:24px">
<div class="card-title">–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è</div>
<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
<div style="font-size:2rem;font-weight:700;color:var(--primary)">v{{ current_version }}</div>
<div id="versionStatus" style="font-size:.875rem;color:var(--text-muted)">–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button onclick="checkUpdates()" class="btn btn-ghost btn-sm" id="checkBtn">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
<button onclick="forceUpdate()" class="btn btn-primary btn-sm" id="updateBtn" style="display:none">‚¨áÔ∏è –û–±–Ω–æ–≤–∏—Ç—å</button>
</div>
</div>
<div class="card" id="updateInfo" style="display:none">
<div class="card-title">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
<div style="margin-bottom:16px">
<div style="font-size:1.5rem;font-weight:600;color:var(--success)" id="latestVersion"></div>
</div>
<div id="releaseChangelog" style="background:var(--bg-input);padding:16px;border-radius:8px;font-size:.875rem;max-height:200px;overflow-y:auto;white-space:pre-wrap"></div>
<div style="margin-top:16px">
<a id="releaseUrl" href="#" target="_blank" class="btn btn-ghost btn-sm">üìÑ GitHub</a>
</div>
</div>
<div class="card" id="noUpdate" style="display:none">
<div style="text-align:center;padding:20px">
<div style="font-size:3rem;margin-bottom:8px">‚úÖ</div>
<div style="font-size:1.125rem;font-weight:500">–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è</div>
</div>
</div>
</div>
<div>
<div class="card">
<div class="card-title">Changelog</div>
<div id="changelogContent" style="font-size:.875rem;line-height:1.8;color:var(--text-muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
</div>
</div>
<script>
function checkUpdates(){
document.getElementById('checkBtn').disabled=true;
document.getElementById('checkBtn').textContent='...';
fetch('/api/check-update').then(r=>r.json()).then(data=>{
document.getElementById('checkBtn').disabled=false;
document.getElementById('checkBtn').textContent='üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
if(data.has_update){
document.getElementById('versionStatus').innerHTML='<span style="color:var(--warning)">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>';
document.getElementById('updateInfo').style.display='block';
document.getElementById('noUpdate').style.display='none';
document.getElementById('latestVersion').textContent='v'+data.latest;
document.getElementById('releaseChangelog').textContent=data.changelog||'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
document.getElementById('releaseUrl').href=data.url;
document.getElementById('updateBtn').style.display='inline-flex';
}else{
document.getElementById('versionStatus').innerHTML='<span style="color:var(--success)">–ê–∫—Ç—É–∞–ª—å–Ω–∞—è</span>';
document.getElementById('updateInfo').style.display='none';
document.getElementById('noUpdate').style.display='block';
document.getElementById('updateBtn').style.display='none';
}
}).catch(()=>{
document.getElementById('checkBtn').disabled=false;
document.getElementById('checkBtn').textContent='üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
document.getElementById('versionStatus').innerHTML='<span style="color:var(--danger)">–û—à–∏–±–∫–∞</span>';
});
}
function forceUpdate(){
if(!confirm('–û–±–Ω–æ–≤–∏—Ç—å? –ü–æ—Å–ª–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è: docker-compose restart'))return;
document.getElementById('updateBtn').disabled=true;
document.getElementById('updateBtn').textContent='...';
fetch('/api/do-update',{method:'POST'}).then(r=>r.json()).then(data=>{
if(data.success){alert('‚úÖ '+data.message);location.reload();}
else{alert('‚ùå '+data.message);document.getElementById('updateBtn').disabled=false;document.getElementById('updateBtn').textContent='‚¨áÔ∏è –û–±–Ω–æ–≤–∏—Ç—å';}
}).catch(e=>{alert('–û—à–∏–±–∫–∞: '+e);document.getElementById('updateBtn').disabled=false;document.getElementById('updateBtn').textContent='‚¨áÔ∏è –û–±–Ω–æ–≤–∏—Ç—å';});
}
function loadChangelog(){
fetch('/api/changelog').then(r=>r.json()).then(data=>{
if(data.success){
const md=data.content;
let html=md
.replace(/^# (.+)$/gm,'<h2 style="color:var(--text);margin:0 0 16px">$1</h2>')
.replace(/^## \[(.+?)\] - (.+)$/gm,'<div style="font-weight:600;color:var(--primary);margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">v$1 <span style="font-weight:400;color:var(--text-muted);font-size:.8rem">$2</span></div>')
.replace(/^### (.+)$/gm,'<div style="font-weight:500;margin-top:12px;color:var(--text)">$1</div>')
.replace(/^- \[.\] (.+)$/gm,'<div style="margin-left:16px;color:var(--text-muted)">‚òê $1</div>')
.replace(/^- (.+)$/gm,'<div style="margin-left:16px">‚Ä¢ $1</div>')
.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
.replace(/---/g,'')
.replace(/\n\n+/g,'<br>');
document.getElementById('changelogContent').innerHTML=html;
}else{
document.getElementById('changelogContent').textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å';
}
}).catch(()=>{document.getElementById('changelogContent').textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';});
}
loadChangelog();
</script>
{% endblock %}
