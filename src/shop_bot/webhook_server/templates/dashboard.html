{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1 class="page-title">Dashboard</h1>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Пользователей</div>
<div class="stat-value">{{ stats.user_count }}</div>
</div>
<div class="stat-card">
<div class="stat-label">Всего ключей</div>
<div class="stat-value">{{ stats.total_keys }}</div>
</div>
<div class="stat-card">
<div class="stat-label">Потрачено</div>
<div class="stat-value">{{ (stats.total_spent or 0)|float|round(2) }} <small>₽</small></div>
</div>
<div class="stat-card">
<div class="stat-label">Тарифов</div>
<div class="stat-value">{{ stats.plans_count }}</div>
</div>
{% if api_balance and api_balance.success %}
<div class="stat-card">
<div class="stat-label">Баланс API</div>
<div class="stat-value">{{ (api_balance.balance or 0)|float|round(2) }} <small>₽</small></div>
</div>
{% endif %}
</div>
<div class="grid-2">
<div>
<div class="chart-box">
<h3>Новые пользователи (30 дней)</h3>
<canvas id="newUsersChart"></canvas>
</div>
<div class="chart-box">
<h3>Новые ключи (30 дней)</h3>
<canvas id="newKeysChart"></canvas>
</div>
</div>
<div>
<div class="card">
<div class="card-title">Недавние транзакции</div>
{% if transactions %}
<div class="table-wrap">
<table>
<thead>
<tr><th>Пользователь</th><th>План</th><th>Сумма</th><th>Дата</th></tr>
</thead>
<tbody>
{% for tx in transactions %}
<tr>
<td>{{ tx.username or 'N/A' }}<br><small style="color:var(--text-muted)">{{ tx.user_id }}</small></td>
<td>{{ tx.plan_name }}</td>
<td>{{ (tx.amount_rub or 0)|float|round(2) }} ₽</td>
<td>{{ tx.created_date.split(' ')[0] }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% if total_pages > 1 %}
<nav class="pagination">
<a href="{{ url_for('dashboard_page', page=current_page - 1) }}" class="{{ 'disabled' if current_page == 1 else '' }}">«</a>
{% for p in range(1, total_pages + 1) %}
<a href="{{ url_for('dashboard_page', page=p) }}" class="{{ 'active' if p == current_page else '' }}">{{ p }}</a>
{% endfor %}
<a href="{{ url_for('dashboard_page', page=current_page + 1) }}" class="{{ 'disabled' if current_page == total_pages else '' }}">»</a>
</nav>
{% endif %}
{% else %}
<p style="color:var(--text-muted)">Транзакций пока нет</p>
{% endif %}
</div>
</div>
</div>
<script>const CHART_DATA = {{ chart_data | tojson }};</script>
{% endblock %}
