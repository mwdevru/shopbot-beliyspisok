{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<h1 class="page-title">Dashboard</h1>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
<div class="stat-value">{{ stats.user_count }}</div>
</div>
<div class="stat-card">
<div class="stat-label">–í—Å–µ–≥–æ –∫–ª—é—á–µ–π</div>
<div class="stat-value">{{ stats.total_keys }}</div>
</div>
<div class="stat-card">
<div class="stat-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
<div class="stat-value">{{ (stats.total_spent or 0)|float|round(2) }} <small>‚ÇΩ</small></div>
</div>
<div class="stat-card">
<div class="stat-label">–¢–∞—Ä–∏—Ñ–æ–≤</div>
<div class="stat-value">{{ stats.plans_count }}</div>
</div>
{% if api_balance and api_balance.success %}
<div class="stat-card">
<div class="stat-label">–ë–∞–ª–∞–Ω—Å API</div>
<div class="stat-value">{{ (api_balance.balance or 0)|float|round(2) }} <small>‚ÇΩ</small></div>
</div>
{% endif %}
</div>
<div class="grid-2">
<div>
<div class="chart-box">
<h3>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (30 –¥–Ω–µ–π)</h3>
<canvas id="newUsersChart"></canvas>
</div>
<div class="chart-box">
<h3>–ù–æ–≤—ã–µ –∫–ª—é—á–∏ (30 –¥–Ω–µ–π)</h3>
<canvas id="newKeysChart"></canvas>
</div>
</div>
<div>
<div class="card" style="margin-bottom:24px">
<div class="card-title">üñ• –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ</div>
<div id="serverInfo" style="font-size:.875rem">
<div style="text-align:center;padding:20px;color:var(--text-muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
</div>
<div class="card">
<div class="card-title">–ù–µ–¥–∞–≤–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
{% if transactions %}
<div class="table-wrap">
<table>
<thead>
<tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–ü–ª–∞–Ω</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th></tr>
</thead>
<tbody>
{% for tx in transactions %}
<tr>
<td>{{ tx.username or 'N/A' }}<br><small style="color:var(--text-muted)">{{ tx.user_id }}</small></td>
<td>{{ tx.plan_name }}</td>
<td>{{ (tx.amount_rub or 0)|float|round(2) }} ‚ÇΩ</td>
<td>{{ tx.created_date.split(' ')[0] }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% if total_pages > 1 %}
<nav class="pagination">
<a href="{{ url_for('dashboard_page', page=current_page - 1) }}" class="{{ 'disabled' if current_page == 1 else '' }}">¬´</a>
{% for p in range(1, total_pages + 1) %}
<a href="{{ url_for('dashboard_page', page=p) }}" class="{{ 'active' if p == current_page else '' }}">{{ p }}</a>
{% endfor %}
<a href="{{ url_for('dashboard_page', page=current_page + 1) }}" class="{{ 'disabled' if current_page == total_pages else '' }}">¬ª</a>
</nav>
{% endif %}
{% else %}
<p style="color:var(--text-muted)">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
{% endif %}
</div>
</div>
</div>
<script>
var CHART_DATA = {{ chart_data | tojson }};
function getColor(val) {
    if (val > 80) return "var(--danger)";
    if (val > 50) return "var(--warning)";
    return "var(--success)";
}
function renderBar(color, percent) {
    return "<div style='background:var(--bg);border-radius:4px;height:6px;overflow:hidden'>" +
           "<div style='background:" + color + ";height:100%;width:" + percent + "%;transition:width .3s'></div></div>";
}
function loadServerInfo() {
    fetch("/api/server-info").then(function(r) { return r.json(); }).then(function(d) {
        if (!d.success) {
            document.getElementById("serverInfo").innerHTML = "<p style='color:var(--danger)'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
            return;
        }
        var cpuC = getColor(d.cpu_percent);
        var memC = getColor(d.memory_percent);
        var diskC = getColor(d.disk_percent);
        var html = "<div style='display:grid;gap:12px'>";
        html += "<div style='display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)'><span style='color:var(--text-muted)'>üè∑ –•–æ—Å—Ç</span><span style='font-weight:500'>" + d.hostname + "</span></div>";
        html += "<div style='display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)'><span style='color:var(--text-muted)'>üíª –û–°</span><span>" + d.os + "</span></div>";
        html += "<div style='display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)'><span style='color:var(--text-muted)'>üêç Python</span><span>" + d.python + "</span></div>";
        html += "<div style='display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)'><span style='color:var(--text-muted)'>‚è± Uptime</span><span>" + d.uptime + "</span></div>";
        html += "<div style='padding:8px 0;border-bottom:1px solid var(--border)'><div style='display:flex;justify-content:space-between;margin-bottom:6px'><span style='color:var(--text-muted)'>‚ö° CPU (" + d.cpu_count + " —è–¥–µ—Ä)</span><span style='color:" + cpuC + ";font-weight:500'>" + d.cpu_percent + "%</span></div>" + renderBar(cpuC, d.cpu_percent) + "</div>";
        html += "<div style='padding:8px 0;border-bottom:1px solid var(--border)'><div style='display:flex;justify-content:space-between;margin-bottom:6px'><span style='color:var(--text-muted)'>üß† RAM</span><span style='color:" + memC + ";font-weight:500'>" + d.memory_used + " / " + d.memory_total + " GB (" + d.memory_percent + "%)</span></div>" + renderBar(memC, d.memory_percent) + "</div>";
        html += "<div style='padding:8px 0'><div style='display:flex;justify-content:space-between;margin-bottom:6px'><span style='color:var(--text-muted)'>üíæ –î–∏—Å–∫</span><span style='color:" + diskC + ";font-weight:500'>" + d.disk_used + " / " + d.disk_total + " GB (" + d.disk_percent + "%)</span></div>" + renderBar(diskC, d.disk_percent) + "</div>";
        html += "</div>";
        document.getElementById("serverInfo").innerHTML = html;
    }).catch(function() {
        document.getElementById("serverInfo").innerHTML = "<p style='color:var(--danger)'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
    });
}
loadServerInfo();
setInterval(loadServerInfo, 10000);
</script>
{% endblock %}