{% extends "base.html" %}
{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px">
<h1 class="page-title" style="margin:0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
<a href="{{ url_for('export_users') }}" class="btn btn-ghost btn-sm">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
</div>
<div class="stats-grid" style="margin-bottom:24px">
<div class="stat-card">
<div class="stat-label">–í—Å–µ–≥–æ</div>
<div class="stat-value">{{ stats.total }}</div>
</div>
<div class="stat-card">
<div class="stat-label">–° –∫–ª—é—á–∞–º–∏</div>
<div class="stat-value">{{ stats.with_keys }}</div>
</div>
<div class="stat-card">
<div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π</div>
<div class="stat-value">{{ stats.active_keys }}</div>
</div>
<div class="stat-card">
<div class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div>
<div class="stat-value">{{ stats.expired_keys }}</div>
</div>
<div class="stat-card">
<div class="stat-label">–ó–∞–±–∞–Ω–µ–Ω–æ</div>
<div class="stat-value">{{ stats.banned }}</div>
</div>
</div>
<div class="card" style="margin-bottom:24px">
<form method="get" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
<div class="form-group" style="margin:0;flex:1;min-width:200px">
<label class="form-label">–ü–æ–∏—Å–∫</label>
<input type="text" name="search" class="form-input" placeholder="ID –∏–ª–∏ username" value="{{ search }}">
</div>
<div class="form-group" style="margin:0">
<label class="form-label">–§–∏–ª—å—Ç—Ä</label>
<select name="filter" class="form-input" style="width:auto">
<option value="all" {% if filter_type == 'all' %}selected{% endif %}>–í—Å–µ</option>
<option value="active" {% if filter_type == 'active' %}selected{% endif %}>–° –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏</option>
<option value="nokeys" {% if filter_type == 'nokeys' %}selected{% endif %}>–ë–µ–∑ –∫–ª—é—á–µ–π</option>
</select>
</div>
<button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
{% if search or filter_type != 'all' %}
<a href="{{ url_for('users_page') }}" class="btn btn-ghost">–°–±—Ä–æ—Å–∏—Ç—å</a>
{% endif %}
</form>
</div>
<div class="users-grid">
{% for user in users %}
<div class="user-card {% if user.is_banned %}banned{% endif %}">
<div class="user-head">
<div class="user-avatar">{{ user.username[0]|upper if user.username else 'U' }}</div>
<div class="user-meta">
<div class="user-name">@{{ user.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</div>
<div class="user-id">{{ user.telegram_id }}</div>
</div>
{% if user.is_banned %}
<span class="badge badge-danger">–ë–∞–Ω</span>
{% else %}
<span class="badge badge-success">–ê–∫—Ç–∏–≤</span>
{% endif %}
</div>
<div class="user-stats">
<div class="user-stat">üîë {{ user.user_keys|length }}</div>
<div class="user-stat">üí∞ {{ "%.0f"|format(user.total_spent or 0) }}‚ÇΩ</div>
<div class="user-stat">üìÖ {{ user.total_months or 0 }} –º–µ—Å</div>
</div>
{% if user.user_keys %}
<div class="user-keys">
{% for key in user.user_keys %}
<span class="key-tag">{{ '‚úì' if key.expiry_date > now else '‚úó' }} {{ key.expiry_date[:10] }}</span>
{% endfor %}
</div>
{% endif %}
<div class="user-actions">
{% if user.is_banned %}
<form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post">
<button type="submit" class="btn btn-success btn-xs">–†–∞–∑–±–∞–Ω</button>
</form>
{% else %}
<form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post" data-confirm="–ó–∞–±–∞–Ω–∏—Ç—å?">
<button type="submit" class="btn btn-warning btn-xs">–ë–∞–Ω</button>
</form>
{% endif %}
<form action="{{ url_for('grant_key_route', user_id=user.telegram_id) }}" method="post" class="inline-form">
<input type="number" name="days" value="30" min="1" max="365" class="input-mini">
<button type="submit" class="btn btn-primary btn-xs">–í—ã–¥–∞—Ç—å</button>
</form>
{% if user.user_keys %}
<form action="{{ url_for('modify_user_days_route', user_id=user.telegram_id) }}" method="post" class="inline-form">
<input type="hidden" name="key_id" value="{{ user.user_keys[0].key_id }}">
<input type="number" name="days" placeholder="+/-" class="input-mini">
<button type="submit" class="btn btn-ghost btn-xs">¬±–î–Ω–∏</button>
</form>
<form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post" data-confirm="–û—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á–∏?">
<button type="submit" class="btn btn-danger btn-xs">–û—Ç–æ–∑–≤–∞—Ç—å</button>
</form>
{% endif %}
</div>
<details style="margin-top:12px">
<summary style="cursor:pointer;font-size:.8rem;color:var(--text-muted)">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</summary>
<form action="{{ url_for('send_message_to_user', user_id=user.telegram_id) }}" method="post" style="margin-top:8px">
<div style="display:flex;gap:8px">
<input type="text" name="message" class="form-input" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" style="flex:1;padding:6px 10px;font-size:.8rem">
<button type="submit" class="btn btn-primary btn-xs">üì§</button>
</div>
</form>
</details>
</div>
{% else %}
<div class="card"><p style="color:var(--text-muted)">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>
{% endfor %}
</div>
{% endblock %}
