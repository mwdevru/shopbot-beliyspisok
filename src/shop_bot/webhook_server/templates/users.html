{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}
{% block content %}

<h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>

<section class="settings-section">
    <div class="users-stats">
        <div class="stat-mini">
            <span class="stat-label">–í—Å–µ–≥–æ</span>
            <span class="stat-value">{{ users|length }}</span>
        </div>
        <div class="stat-mini">
            <span class="stat-label">–° –∫–ª—é—á–∞–º–∏</span>
            <span class="stat-value">{{ users|selectattr('user_keys')|list|length }}</span>
        </div>
    </div>

    <div class="users-grid">
        {% for user in users %}
        <div class="user-card {% if user.is_banned %}user-banned{% endif %}">
            <div class="user-header">
                <div class="user-avatar">
                    {{ user.username[0]|upper if user.username else 'U' }}
                </div>
                <div class="user-info">
                    <div class="user-name">@{{ user.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</div>
                    <div class="user-id">ID: {{ user.telegram_id }}</div>
                </div>
                <div class="user-status">
                    {% if user.is_banned %}
                    <span class="badge badge-danger">–ó–∞–±–∞–Ω–µ–Ω</span>
                    {% else %}
                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </div>
            </div>

            <div class="user-stats-row">
                <div class="user-stat">
                    <span class="stat-icon">üîë</span>
                    <span>{{ user.user_keys|length }} –∫–ª—é—á–µ–π</span>
                </div>
                <div class="user-stat">
                    <span class="stat-icon">üí∞</span>
                    <span>{{ "%.0f"|format(user.total_spent or 0) }} ‚ÇΩ</span>
                </div>
                <div class="user-stat">
                    <span class="stat-icon">üìÖ</span>
                    <span>{{ user.total_months or 0 }} –º–µ—Å.</span>
                </div>
            </div>

            {% if user.user_keys %}
            <div class="user-keys">
                {% for key in user.user_keys %}
                <div class="key-item">
                    <span class="key-icon">{{ '‚úÖ' if key.expiry_date > now else '‚ùå' }}</span>
                    <span class="key-expiry">–¥–æ {{ key.expiry_date[:10] }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="user-actions">
                {% if user.is_banned %}
                <form action="{{ url_for('unban_user_route', user_id=user.telegram_id) }}" method="post">
                    <button type="submit" class="btn btn-success btn-sm">‚úì –†–∞–∑–±–∞–Ω–∏—Ç—å</button>
                </form>
                {% else %}
                <form action="{{ url_for('ban_user_route', user_id=user.telegram_id) }}" method="post" data-confirm="–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?">
                    <button type="submit" class="btn btn-warning btn-sm">‚õî –ë–∞–Ω</button>
                </form>
                {% endif %}

                <form action="{{ url_for('grant_key_route', user_id=user.telegram_id) }}" method="post" class="inline-form">
                    <input type="number" name="days" value="30" min="1" max="365" class="input-mini">
                    <button type="submit" class="btn btn-primary btn-sm">üéÅ –í—ã–¥–∞—Ç—å</button>
                </form>

                {% if user.user_keys %}
                <form action="{{ url_for('modify_user_days_route', user_id=user.telegram_id) }}" method="post" class="inline-form">
                    <input type="hidden" name="key_id" value="{{ user.user_keys[0].key_id }}">
                    <input type="number" name="days" placeholder="+/-" class="input-mini">
                    <button type="submit" class="btn btn-secondary btn-sm">üìÖ –î–Ω–∏</button>
                </form>

                <form action="{{ url_for('revoke_keys_route', user_id=user.telegram_id) }}" method="post" data-confirm="–û—Ç–æ–∑–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏?">
                    <button type="submit" class="btn btn-danger btn-sm">üóë –û—Ç–æ–∑–≤–∞—Ç—å</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>

{% endblock %}
