{% extends "base.html" %}
{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px">
<h1 class="page-title" style="margin:0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
<a href="{{ url_for('export_users') }}" class="btn btn-ghost btn-sm">üì• CSV</a>
</div>
<div class="stats-grid" style="margin-bottom:24px">
<div class="stat-card"><div class="stat-label">–í—Å–µ–≥–æ</div><div class="stat-value">{{ stats.total }}</div></div>
<div class="stat-card"><div class="stat-label">–° –∫–ª—é—á–∞–º–∏</div><div class="stat-value">{{ stats.with_keys }}</div></div>
<div class="stat-card"><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div><div class="stat-value">{{ stats.active_keys }}</div></div>
<div class="stat-card"><div class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö</div><div class="stat-value">{{ stats.expired_keys }}</div></div>
<div class="stat-card"><div class="stat-label">–ë–∞–Ω</div><div class="stat-value">{{ stats.banned }}</div></div>
</div>
<div class="card" style="margin-bottom:24px;padding:16px">
<form method="get" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
<input type="text" name="search" class="form-input" placeholder="ID –∏–ª–∏ @username" value="{{ search }}" style="flex:1;min-width:180px">
<select name="filter" class="form-input" style="width:auto">
<option value="all" {% if filter_type == 'all' %}selected{% endif %}>–í—Å–µ</option>
<option value="active" {% if filter_type == 'active' %}selected{% endif %}>–° –∫–ª—é—á–∞–º–∏</option>
<option value="nokeys" {% if filter_type == 'nokeys' %}selected{% endif %}>–ë–µ–∑ –∫–ª—é—á–µ–π</option>
</select>
<button type="submit" class="btn btn-primary btn-sm">–ù–∞–π—Ç–∏</button>
{% if search or filter_type != 'all' %}<a href="{{ url_for('users_page') }}" class="btn btn-ghost btn-sm">√ó</a>{% endif %}
</form>
</div>
<div class="card">
{% if users %}
<div class="table-wrap">
<table>
<thead>
<tr>
<th style="width:50px"></th>
<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
<th>–ö–ª—é—á–µ–π</th>
<th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
<th>–°—Ç–∞—Ç—É—Å</th>
<th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
<th></th>
</tr>
</thead>
<tbody>
{% for user in users %}
<tr class="clickable-row" data-href="{{ url_for('user_detail_page', user_id=user.telegram_id) }}">
<td><div class="user-avatar" style="width:36px;height:36px;font-size:.9rem">{{ user.username[0]|upper if user.username else 'U' }}</div></td>
<td>
<div style="font-weight:500">@{{ user.username or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</div>
<div style="font-size:.75rem;color:var(--text-muted);font-family:monospace">{{ user.telegram_id }}</div>
</td>
<td>
{% set active = user.user_keys|selectattr('expiry_date', '>', now)|list|length %}
{% if user.user_keys %}
<span style="color:var(--success)">{{ active }}</span> / {{ user.user_keys|length }}
{% else %}
<span style="color:var(--text-muted)">‚Äî</span>
{% endif %}
</td>
<td>{{ "%.0f"|format(user.total_spent or 0) }} ‚ÇΩ</td>
<td>
{% if user.is_banned %}<span class="badge badge-danger">–ë–∞–Ω</span>
{% else %}<span class="badge badge-success">–ê–∫—Ç–∏–≤</span>{% endif %}
</td>
<td style="font-size:.8rem;color:var(--text-muted)">{{ user.registration_date[:10] if user.registration_date else '‚Äî' }}</td>
<td style="text-align:right">
<a href="{{ url_for('user_detail_page', user_id=user.telegram_id) }}" class="btn btn-ghost btn-xs" onclick="event.stopPropagation()">‚Üí</a>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<p style="color:var(--text-muted);padding:20px;text-align:center">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
{% endif %}
</div>
{% endblock %}
